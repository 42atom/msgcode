{%- if not add_generation_prompt is defined -%}
    {%- set add_generation_prompt = true -%}
{%- endif -%}
{%- if not cls_token is defined -%}
    {%- set cls_token = "<|begin_of_sentence|>" -%}
{%- endif -%}
{%- if not eos_token is defined -%}
    {%- set eos_token = "</s>" -%}
{%- endif -%}
{{- cls_token -}}
{%- for message in messages -%}
    {%- if message["role"] == "user" -%}
        {{- "User: " -}}
        {%- if message["content"] is string -%}
            {{ message["content"] }}
        {%- else -%}
            {%- for content in message["content"] -%}
                {%- if content["type"] in ["image","image_url"] -%}
                    {{ "<|IMAGE_START|><|IMAGE_PLACEHOLDER|><|IMAGE_END|>" }}
                {%- endif -%}
            {%- endfor -%}
            {%- for content in message["content"] -%}
                {%- if content["type"] == "text" -%}
                    {{ content["text"] }}
                {%- endif -%}
            {%- endfor -%}
        {%- endif -%}
        {{ "\n" -}}

    {%- elif message["role"] == "assistant" -%}
        {{- "Assistant:\n" -}}
        {%- if message["content"] is string -%}
            {{ message["content"] }}
        {%- else -%}
            {%- for content in message["content"] -%}
                {%- if content["type"] == "text" -%}
                    {{ content["text"] }}
                {%- endif -%}
            {%- endfor -%}
        {%- endif -%}
        {{ eos_token -}}

    {%- elif message["role"] == "system" -%}
        {%- if message["content"] is string -%}
            {{ message["content"] + "\n" }}
        {%- else -%}
            {%- for content in message["content"] -%}
                {%- if content["type"] == "text" -%}
                    {{ content["text"] + "\n" }}
                {%- endif -%}
            {%- endfor -%}
        {%- endif -%}
    {%- endif -%}
{%- endfor -%}
{%- if add_generation_prompt -%}
    {{- "Assistant:\n" -}}
{%- endif -%}

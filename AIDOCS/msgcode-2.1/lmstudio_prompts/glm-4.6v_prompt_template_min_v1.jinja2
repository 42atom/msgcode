[gMASK]<sop>
{# GLM-4.6V（vision）最小稳定 Prompt Template #}
{# 目标：不输出 <think>/<tool_call> 结构；支持 image_url/video_url 占位符 #}

{%- macro visible_text(content) -%}
  {%- if content is string -%}
    {{- content -}}
  {%- elif content is iterable and content is not mapping -%}
    {%- for item in content -%}
      {%- if item is mapping and item.type == 'text' and item.text is defined -%}
        {{- item.text -}}
      {%- elif item is mapping and item.type in ['image', 'image_url'] -%}
        <|begin_of_image|><|image|><|end_of_image|>
      {%- elif item is mapping and item.type in ['video', 'video_url'] -%}
        <|begin_of_video|><|video|><|end_of_video|>
      {%- elif item is string -%}
        {{- item -}}
      {%- endif -%}
    {%- endfor -%}
  {%- else -%}
    {{- content -}}
  {%- endif -%}
{%- endmacro -%}

{%- for m in messages -%}
{%- if m.role == 'system' -%}
<|system|>
{{ visible_text(m.content) }}

{%- elif m.role == 'user' -%}
<|user|>
{{ visible_text(m.content) }}

{%- elif m.role == 'assistant' -%}
<|assistant|>
{{ visible_text(m.content) }}

{%- endif -%}
{%- endfor -%}

<|assistant|>

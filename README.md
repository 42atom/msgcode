# msgcode

> ç”¨ iMessage æ›¿ä»£ Matrixï¼Œå®ç° Mac æœ¬åœ°çš„ AI Bot ç³»ç»Ÿ

[![PRD](https://img.shields.io/badge/PRD-v0.1-blue)](./PRD.md)

---

## ç®€ä»‹

msgcode æ˜¯ä¸€ä¸ªåŸºäº iMessage çš„æœ¬åœ° AI Bot ç³»ç»Ÿï¼Œé€šè¿‡ç¾¤ç»„è·¯ç”±å®ç°å¤šä¸ª Bot/Agent ä¼šè¯ã€‚æ— éœ€äº‘æœåŠ¡å™¨ï¼Œç®€åŒ–è¿ç»´ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **iMessage é›†æˆ**: åŸºäº `@photon-ai/imessage-kit` (SDK)
- **ç¾¤ç»„è·¯ç”±**: ä¸åŒç¾¤ç»„ â†’ å¯¹åº” Claude Project / Bot
- **åŒå‘é€šä¿¡**:
  - è¾“å…¥: iMessage â†’ tmux send-keys
  - è¾“å‡º: Claude JSONL â†’ iMessage å›å¤
- **å®‰å…¨æœºåˆ¶**: ç™½åå•éªŒè¯ (Email/Phone)

---

## é…ç½®æ–‡ä»¶

msgcode ä¼˜å…ˆä» `~/.config/msgcode/.env` è¯»å–é…ç½®ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å›é€€åˆ°é¡¹ç›®æ ¹ç›®å½•çš„ `.env` æ–‡ä»¶ã€‚

### é¦–æ¬¡å®‰è£…

```bash
# åˆ›å»ºé…ç½®ç›®å½•
mkdir -p ~/.config/msgcode/log

# å¤åˆ¶ç¤ºä¾‹é…ç½®
cp .env.example ~/.config/msgcode/.env

# ç¼–è¾‘é…ç½®
vim ~/.config/msgcode/.env
```

### é…ç½®è¿ç§»

å¦‚æœä½ å·²ç»åœ¨ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•çš„ `.env`ï¼Œå¯ä»¥è¿ç§»åˆ°ç”¨æˆ·é…ç½®ç›®å½•ï¼š

```bash
# åˆ›å»ºé…ç½®ç›®å½•
mkdir -p ~/.config/msgcode/log

# å¤åˆ¶ç°æœ‰é…ç½®
cp .env ~/.config/msgcode/.env

# éªŒè¯
ls -la ~/.config/msgcode/
```

## æ—¥å¿—

msgcode ä½¿ç”¨åŒå†™ç­–ç•¥ï¼šåŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°å’Œæ—¥å¿—æ–‡ä»¶ã€‚

### æ—¥å¿—ä½ç½®

æ—¥å¿—æ–‡ä»¶ä½äº `~/.config/msgcode/log/msgcode.log`

### æ—¥å¿—çº§åˆ«

é€šè¿‡ `LOG_LEVEL` ç¯å¢ƒå˜é‡æ§åˆ¶ï¼š

- `debug` - è°ƒè¯•ä¿¡æ¯ï¼ˆè¯¦ç»†ï¼‰
- `info` - å¸¸è§„ä¿¡æ¯ï¼ˆé»˜è®¤ï¼‰
- `warn` - è­¦å‘Šä¿¡æ¯
- `error` - é”™è¯¯ä¿¡æ¯ï¼ˆæœ€å°‘ï¼‰

åœ¨ `.env` ä¸­è®¾ç½®ï¼š

```bash
LOG_LEVEL=info
```

### æ—¥å¿—è½®è½¬

- å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§ 10MB
- è‡ªåŠ¨è½®è½¬ï¼Œä¿ç•™æœ€è¿‘ 3 ä¸ªæ—¥å¿—æ–‡ä»¶
- è½®è½¬åçš„æ–‡ä»¶å‘½åï¼š`msgcode.log.1`, `msgcode.log.2`, `msgcode.log.3`

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æœ€æ–°æ—¥å¿—
tail -f ~/.config/msgcode/log/msgcode.log

# æŸ¥çœ‹æœ€è¿‘ 50 è¡Œ
tail -50 ~/.config/msgcode/log/msgcode.log

# æœç´¢é”™è¯¯
grep ERROR ~/.config/msgcode/log/msgcode.log
```

---

## å¾…åŠ / TODO

- æ—¥å¿—ä¸ç›‘æ§ï¼šå¢åŠ å´©æºƒé‡å¯é€šçŸ¥çš„å¤–éƒ¨æ¨é€/å…³é”®æŒ‡æ ‡è¾“å‡ºï¼ˆç›®å‰ä»…æœ¬åœ°æ—¥å¿—ï¼‰ã€‚
- é…ç½®å¥å£®æ€§ï¼šæ”¯æŒé…ç½®çƒ­åŠ è½½æˆ–æä¾›é‡å¯æç¤ºæœºåˆ¶ã€‚
- æµ‹è¯•éš”ç¦»ï¼šæµ‹è¯•æ¨¡å¼ä¸‹ mock markAsReadï¼Œé¿å…æœ¬åœ° chat.db æƒé™è­¦å‘Šã€‚

---

## å¿«é€Ÿå¼€å§‹

### 1. ç³»ç»Ÿè¦æ±‚

- macOS (éœ€æˆäºˆ Terminal/IDE "å®Œå…¨ç£ç›˜è®¿é—®æƒé™")
- Node.js >= 18.0.0
- iMessage å·²ç™»å½•
- Claude Code (`claude`) å·²å®‰è£…å¹¶ç™»å½•

> **âš ï¸ é‡è¦ï¼šå…³é—­ iCloud æ¶ˆæ¯åŒæ­¥**
>
> ä½¿ç”¨æœ¬ç³»ç»Ÿå‰ï¼Œ**å¿…é¡»å…³é—­ macOS çš„ iCloud æ¶ˆæ¯åŒæ­¥**ï¼š
>
> ```
> ç³»ç»Ÿè®¾ç½® â†’ Apple ID â†’ iCloud â†’ å…³é—­"ä¿¡æ¯ï¼ˆMessagesï¼‰"
> ```
>
> **åŸå› **ï¼šiCloud åŒæ­¥ä¼šå¹²æ‰°æœ¬åœ°æ•°æ®åº“æ“ä½œï¼Œå¯¼è‡´ï¼š
> - æ¶ˆæ¯æ£€æµ‹å¤±æ•ˆï¼ˆäº‘ç«¯è¦†ç›–æœ¬åœ°çŠ¶æ€ï¼‰
> - markAsRead æ— æ•ˆï¼ˆå†™å…¥è¢«äº‘ç«¯å›æ»šï¼‰
> - å‘é€è€…èº«ä»½æ··ä¹±ï¼ˆå¤šè®¾å¤‡åŒæ­¥å†²çªï¼‰
>
> **å°¤å…¶æ³¨æ„**ï¼šå½“ macOS ç™»å½•è´¦å·ä¸ Bot èº«ä»½ä¸ä¸€è‡´æ—¶ï¼Œé—®é¢˜æ›´ä¸¥é‡ã€‚

### 2. å®‰è£…

```bash
# å…‹éš†é¡¹ç›®
cd /path/to/msgcode

# å®‰è£…ä¾èµ–
npm install

# å¤åˆ¶é…ç½®æ¨¡æ¿
cp .env.example .env
```

### 3. è·å–ç¾¤ç»„ ID

```bash
# è¿è¡Œå·¥å…·è·å–ç¾¤ç»„åˆ—è¡¨
npm run get-chats
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
ğŸ“ ç¾¤ç»„ (3)
  1. Code Bot
     guid: i chat;+;chat1234
  2. Image Bot
     guid: i chat;+;chat5678
```

### 4. é…ç½® .env

```bash
# é…ç½®ç™½åå•
MY_EMAIL=me@icloud.com

# é…ç½®ç¾¤ç»„è·¯ç”±
# æ ¼å¼: GROUP_<NAME>=<GUID>:<PROJECT_DIR>:<BOT_TYPE>
GROUP_MATCODE=i chat;+;chat1234:/Users/<you>/Dev/my-project:code
```

### 5. å¯åŠ¨ Bot

```bash
# å¯åŠ¨ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰
npm start
```

---

## ç›®å½•ç»“æ„

```
msgcode/
â”œâ”€â”€ PRD.md               # äº§å“éœ€æ±‚æ–‡æ¡£
â”œâ”€â”€ README.md            # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ package.json         # ä¾èµ–é…ç½®
â”œâ”€â”€ .env                 # é…ç½®æ–‡ä»¶
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ get-chats.ts     # è·å–ç¾¤ç»„å·¥å…·
â””â”€â”€ src/
    â”œâ”€â”€ index.ts         # ä¸»å…¥å£
    â”œâ”€â”€ config.ts        # é…ç½®åŠ è½½
    â”œâ”€â”€ router.ts        # ç¾¤ç»„è·¯ç”±
    â”œâ”€â”€ security.ts      # å®‰å…¨éªŒè¯
    â”œâ”€â”€ listener.ts      # æ¶ˆæ¯ç›‘å¬å™¨
    â”œâ”€â”€ handlers.ts      # å‘½ä»¤åˆ†å‘
    â”œâ”€â”€ tmux/            # tmux ä¼šè¯ç®¡ç†
    â”‚   â”œâ”€â”€ session.ts   # ä¼šè¯æ§åˆ¶
    â”‚   â”œâ”€â”€ sender.ts    # å‘é€å™¨
    â”‚   â””â”€â”€ responder.ts # å“åº”å™¨ (æ ¸å¿ƒé€»è¾‘)
    â””â”€â”€ output/          # Claude è¾“å‡ºå¤„ç†
        â”œâ”€â”€ reader.ts    # JSONL å¢é‡è¯»å–
        â””â”€â”€ parser.ts    # æ¶ˆæ¯è§£æ
```

---

**Tip:** `msgcode start` åœ¨åå°é™é»˜è¿è¡Œå¹¶æŠŠæ—¥å¿—å†™å…¥ `~/.config/msgcode/log/msgcode.log`ï¼Œ`msgcode start debug` åˆ™æŠŠæ—¥å¿—åŒæ­¥è¾“å‡ºåˆ°å½“å‰ç»ˆç«¯ï¼›å¦‚æœéœ€è¦å®æ—¶çœ‹åˆ° Claude çš„ç»ˆç«¯å†…å®¹ï¼Œå¯ä»¥ç”¨ `LOG_CONSOLE=true msgcode start debug`ï¼Œè®© tmux å†…å®¹åŒæ—¶å†™å…¥æ§åˆ¶å°å’Œæ—¥å¿—ï¼Œæ–¹ä¾¿åœ¨ iMessage é‡Œå¿«é€Ÿåˆ¤æ–­ã€ŒDo you want to proceed?ã€ç­‰äº’åŠ¨æç¤ºã€‚

`msgcode stop` åªåœæ­¢ msgcode è¿›ç¨‹ï¼ˆä¿ç•™ tmuxï¼Œä¼šè¯ä¸Šä¸‹æ–‡ä¸ä¸¢ï¼‰ï¼›å¦‚æœä½ æƒ³å½»åº•æ¸…ç†æ‰€æœ‰ `msgcode-` å‰ç¼€çš„ tmux ä¼šè¯ï¼Œå†è¿è¡Œ `msgcode allstop`ï¼ˆæˆ– `msgcode stopall`ï¼‰ã€‚

### çŠ¶æ€ä¸å¿«ç…§å‘½ä»¤è¯¦è§£

- `/status` ä¼šå‘ `tmux capture-pane -t msgcode-<group> -p -S -100` è¯·æ±‚å½“å‰çŠ¶æ€ï¼Œå›æ˜¾ Claude æ˜¯ readyã€æ­£åœ¨æ‰§è¡Œè¿˜æ˜¯ç­‰å¾…ä½ çš„è¾“å…¥ï¼ˆé€‚ç”¨äºç¡®è®¤ 1/2/3 äº¤äº’ï¼‰ã€‚
- `/snapshot` ä¼šè·‘ `tmux capture-pane -t msgcode-<group> -p -J`ï¼ŒæŠŠæœ€è¿‘ 200 è¡Œç»ˆç«¯å†…å®¹æ‰“åŒ…å‘å›æ¥ï¼Œæ–¹ä¾¿åœ¨æ‰‹æœºä¸Šçœ‹åˆ° promptã€æˆæƒæç¤ºæˆ– CLI çš„å†…éƒ¨æ—¥å¿—ã€‚
- `/resume` è¡¨ç¤ºä½ å·²ç»åœ¨ tmux ä¸­æ‰‹åŠ¨å›äº†é‚£æ¡äº¤äº’æç¤ºï¼ˆæ¯”å¦‚ â€œDo you want to proceed?â€ã€`1. Yes / 2. No`ï¼‰ï¼Œæ¥ä¸‹æ¥ç»§ç»­åœ¨ç¾¤ç»„é‡Œå‘æ¶ˆæ¯å³å¯æ¢å¤å¯¹è¯ã€‚ä½ å¯ä»¥åœ¨æœ¬æœºç»ˆç«¯æ‰§è¡Œ `tmux attach -t msgcode-<group>` æˆ– `tmux send-keys -t msgcode-<group> "1" Enter`ï¼Œä¹Ÿå¯ä»¥åœ¨ `LOG_CONSOLE=true msgcode start debug` ä¸‹è§‚å¯Ÿ prompt å†è¿”å› tmux æ“ä½œã€‚

å½“ tmux é‡Œå‡ºç° `Read(~/Library/Mobile...): Do you want to proceed?` ä¹‹ç±»æƒé™/æ–‡ä»¶æç¤ºæ—¶ï¼Œè¯·å…ˆåœ¨ tmux ç»ˆç«¯æ‰‹åŠ¨è¾“å…¥å¯é€‰é¡¹ï¼Œè¿™æ · Claude ä¼šç»§ç»­è¿è¡Œï¼›è‹¥æƒ³è·³è¿‡æ¯æ¬¡ç¡®è®¤ï¼Œå¯ä»¥åœ¨ macOS ç³»ç»Ÿè®¾ç½® â†’ éšç§ä¸å®‰å…¨æ€§ â†’ "å®Œå…¨ç£ç›˜è®¿é—®" ä¸­æ·»åŠ  Terminalï¼ˆæˆ– VS Codeï¼‰ã€æˆäºˆ `Messages` æ•°æ®åº“è¯»å†™ï¼Œä¹‹åå†å¯åŠ¨ `msgcode` å³å¯ã€‚

---

## å¸¸ç”¨å‘½ä»¤

åœ¨ iMessage ç¾¤ç»„ä¸­å‘é€ï¼š

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `/start` | å¯åŠ¨æˆ–æ¢å¤ä¼šè¯ï¼ˆtmux å·²åœ¨å°±å¤ç”¨ï¼‰ |
| `/stop` | åœæ­¢ä¼šè¯ï¼ˆkill tmuxï¼‰ |
| `/status` | æŸ¥çœ‹ä¼šè¯çŠ¶æ€ |
| `/snapshot` | è·å–ç»ˆç«¯å½“å‰å±å¹•æˆªå›¾ (æ–‡æœ¬) |
| `/clear` | æ–°çº¿ç¨‹ï¼ˆkill + startï¼‰ï¼Œç”¨äºä»é›¶å¼€å§‹ |
| `/resume` | æ¢å¤äº¤äº’ï¼ˆéœ€è¦ä½ åœ¨ tmux é‡Œæ‰‹åŠ¨é€‰ 1/2/3ï¼‰ |
| `/esc` | å‘é€ ESC ä¸­æ–­æ“ä½œ |
| `/help` | æ˜¾ç¤ºå¸®åŠ© |
| *(ç›´æ¥å‘æ¶ˆæ¯)* | å‘é€ç»™ Claude å¹¶ç­‰å¾…å›å¤ |

---

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆ Claude ä¸å›å¤ï¼Ÿ
A:
1. **æ£€æŸ¥ iCloud æ¶ˆæ¯åŒæ­¥æ˜¯å¦å…³é—­**ï¼ˆæœ€å¸¸è§åŸå› ï¼‰
2. ç¡®ä¿å·²å‘é€ `/start` å¯åŠ¨ä¼šè¯ã€‚
3. ç¡®ä¿ Bot æœ‰è¯»å– `~/Library/Messages` çš„æƒé™ (Full Disk Access)ã€‚
4. æ£€æŸ¥ `.env` é…ç½®çš„è·¯å¾„æ˜¯å¦æ­£ç¡®ã€‚

### Q: æ¶ˆæ¯æ˜¾ç¤ºçš„å‘é€è€…èº«ä»½ä¸å¯¹ï¼Ÿ
A: è¿™æ˜¯ iCloud åŒæ­¥å¯¼è‡´çš„å¤šè®¾å¤‡å†²çªã€‚å…³é—­ macOS çš„ iCloud æ¶ˆæ¯åŒæ­¥å³å¯è§£å†³ã€‚

### Q: å¦‚ä½•æ”¯æŒå¤šä¸ªé¡¹ç›®ï¼Ÿ
A: åœ¨ iMessage å»ºç«‹å¤šä¸ªç¾¤ç»„ï¼Œåœ¨ `.env` ä¸­åˆ†åˆ«é…ç½®ä¸åŒçš„ `GROUP_*` å’Œå¯¹åº”çš„é¡¹ç›®è·¯å¾„ã€‚

---

## ä¾èµ–

- `@photon-ai/imessage-kit`: iMessage æ•°æ®åº“è¯»å–ä¸å‘é€
- `tmux`: ç»ˆç«¯å¤šè·¯å¤ç”¨å™¨ (ç³»ç»Ÿè‡ªå¸¦æˆ– brew å®‰è£…)
- `claude`: Claude Code CLI å·¥å…·

---

## è®¸å¯

MIT

---

*æ›´æ–°: 2026-01-09*
